worker_processes auto;
pid /var/run/nginx.pid;

events {
    worker_connections 1024;
}

http {
	##
	# /  (root) location
	##
#	map $request_uri $cache_control_root {
#		~^/(?:assets/)?(?:[^/]+/)*[^/]+\.(?:js|css|png|jpg|jpeg|gif|webp|svg|ico|woff2?|ttf)(?:\?.*)?$                         "public, max-age=300";
#		default                                                                                                 "no-store, no-cache, must-revalidate";
#	}




	map $request_uri $pragma_root {
		default "";
		~^/(?!.*\.(js|css|mjs|map|json|png|jpg|jpeg|gif|webp|svg|ico|woff2?|ttf)(\?.*)?$)  "no-cache";
	}
	# CSP #
	map $request_uri $csp_root {
		~^/  "default-src 'self';
			  connect-src 'self' https://localhost;
			  img-src 'self' data:;
			  style-src 'self' 'unsafe-inline';
			  script-src 'self' 'unsafe-inline';
			  worker-src 'self' blob: data:;
			  frame-ancestors 'none';
			  base-uri 'none';";
	}

	##
	# /iam-service location
	##
#	map $request_uri $cache_control_iam {
#		~^/iam-service/(?:[^/]+/)*[^/]+\.(?:js|css|png|jpg|jpeg|gif|webp|svg|ico|woff2?|ttf)$  "public, max-age=86400";
#		default                                                                   "no-store";
#	}

	map $request_uri $pragma_iam {
		default "";
		~^/iam-service/(?!.*\.(js|css|png|jpg|jpeg|gif|webp|svg|ico|woff2?|ttf)$)  "no-cache";
	}

	##
	# /admin-portal location
	##
	map $request_uri $cache_control_admin {
		~^/admin-portal/(callback|silent-renew)                                                                         "no-store, no-cache, must-revalidate";
		~^/admin-portal/(?:[^/]+/)*[^/]+\.(?:js|css|png|jpg|jpeg|gif|webp|svg|ico|woff2?|ttf)(?:\?.*)?$                               "public, max-age=300";
		default                                                                                                         "no-store, no-cache, must-revalidate";
	}

	map $request_uri $pragma_admin {
		default "";
		~^/admin-portal/(callback|silent-renew)  "no-cache";
		~^/admin-portal/(?!.*\.(js|css|mjs|map|json|png|jpg|jpeg|gif|webp|svg|ico|woff2?|ttf)(\?.*)?$)  "no-cache";
	}

	map $request_uri $referrer_policy_admin {
		default "";
		~^/admin-portal/(callback|silent-renew)  "no-referrer";
	}
	# CSP #
	map $request_uri $csp_admin {
		~^/admin-portal/  "default-src 'self';
						   connect-src 'self' https://localhost;
						   img-src 'self' data:;
						   style-src 'self' 'unsafe-inline';
						   script-src 'self' 'unsafe-inline';
						   worker-src 'self' blob: data:;
						   frame-ancestors 'none';
						   base-uri 'none';";
	}


    server_tokens off;

    # MIME types
    include       mime.types;
    default_type  application/octet-stream;

    # Logging
    access_log /var/log/nginx/access.log;
    error_log  /var/log/nginx/error.log warn;


    # SSL settings
    ssl_protocols TLSv1.3;
    ssl_conf_command Ciphersuites TLS_AES_256_GCM_SHA384:TLS_CHACHA20_POLY1305_SHA256:TLS_AES_128_GCM_SHA256;
    ssl_prefer_server_ciphers on;
    ssl_session_timeout 10m;
    ssl_session_cache shared:SSL:10m;
    ssl_session_tickets off;

    # Global security headers
    add_header Strict-Transport-Security "max-age=63072000; includeSubDomains; preload" always;
    add_header Permissions-Policy "geolocation=(), microphone=(), camera=()" always;
    add_header X-Content-Type-Options "nosniff" always;
    #add_header X-Frame-Options "DENY" always;
    add_header Referrer-Policy "no-referrer" always;
    add_header X-XSS-Protection "1; mode=block" always;
	
	# Compression	
    gzip on;
    gzip_comp_level 6;
    gzip_vary on;
    gzip_min_length 1024;
    gzip_types text/plain text/css application/javascript application/json application/xml image/svg+xml;



    server {
        listen 443 ssl;
        http2 off;
        
        server_name localhost;

        ssl_certificate     /etc/nginx/certs/server.crt;
        ssl_certificate_key /etc/nginx/certs/server.key;

        # =========================
        # 1. Keycloak proxy
        # =========================
        location /iam-service/ {
            proxy_pass         https://keycloak:8443;
            proxy_http_version 1.1;
            proxy_set_header   Host $host;
			
			# RFC 7239 Forwarded header
			proxy_set_header Forwarded "for=$remote_addr;proto=$scheme;host=$host";

			# TLS verification to backend (reencrypt mode)
			# Upstream TLS: enable SNI + modern protocols/ciphers
			proxy_ssl_server_name on;
			proxy_ssl_name localhost;  # matches your KC_HOSTNAME/cert CN
			proxy_ssl_protocols TLSv1.3 TLSv1.2;
			proxy_ssl_conf_command Ciphersuites TLS_AES_256_GCM_SHA384:TLS_CHACHA20_POLY1305_SHA256:TLS_AES_128_GCM_SHA256;

			# Verification: turn ON in prod with your CA/cert bundle
			proxy_ssl_verify off;
			# proxy_ssl_verify on;
			# proxy_ssl_trusted_certificate /etc/nginx/ssl/keycloak-ca.pem;

			# Timeouts
			proxy_read_timeout 75s;
			proxy_connect_timeout 5s;
			
			#add_header Cache-Control $cache_control_iam always;
			#if ($pragma_iam != "") { add_header Pragma $pragma_iam always; }

			#if ($cache_control_iam = "public, max-age=86400") { expires 1d; }
        }
		
		# =========================
        # 2. Main React SPA
        # =========================
        location / {
            proxy_pass         http://localhost:5173;
            proxy_http_version 1.1;
            proxy_set_header   Upgrade $http_upgrade;
            proxy_set_header   Connection 'upgrade';
            proxy_set_header   Host $host;
			proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
			proxy_set_header X-Forwarded-Proto $scheme;
			proxy_set_header X-Forwarded-Port $server_port;
            proxy_cache_bypass $http_upgrade;
			
			add_header Cache-Control "public, max-age=300" always;
			
			#add_header Cache-Control $cache_control_root always;
			#if ($pragma_root != "") { add_header Pragma $pragma_root always; }

			#if ($cache_control_root = "public, max-age=300") { expires 5m; }
					
			#if ($csp_root != "") { add_header Content-Security-Policy $csp_root always; }

			add_header X-Frame-Options "DENY" always;
        }
		
		# =========================
        # 3. Admin portal SPA
        # =========================
		location /admin-portal/ {
            proxy_pass         http://localhost:4173;
            proxy_http_version 1.1;
            proxy_set_header   Upgrade $http_upgrade;
            proxy_set_header   Connection 'upgrade';
            proxy_set_header   Host $host;
			proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
			proxy_set_header X-Forwarded-Proto $scheme;
			proxy_set_header X-Forwarded-Port $server_port;
            proxy_cache_bypass $http_upgrade;
			
			add_header Cache-Control "public, max-age=300" always;

			#add_header Cache-Control $cache_control_admin always;
			#if ($pragma_admin != "") { add_header Pragma $pragma_admin always; }
			#if ($referrer_policy_admin != "") { add_header Referrer-Policy $referrer_policy_admin always; }

			#if ($cache_control_admin = "public, max-age=300") { expires 5m; }
			
			#if ($csp_admin != "") { add_header Content-Security-Policy $csp_admin always; }

			add_header X-Frame-Options "DENY" always;
        }
		
		# =========================
        # 4. Backend API
        # =========================
        location /user-service/ {
            proxy_pass         http://localhost:8080/user-service/;
            proxy_http_version 1.1;
            proxy_set_header   Host $host;
            proxy_set_header   X-Forwarded-For $proxy_add_x_forwarded_for;
            proxy_set_header   X-Forwarded-Proto $scheme;
            proxy_set_header   X-Forwarded-Port $server_port;

            add_header Cache-Control "private, no-store" always;
            add_header Pragma "no-cache" always;
			
			add_header X-Frame-Options "DENY" always;
        }
		
		location /upload-service/ {
            proxy_pass         http://localhost:8081/upload-service/;
            proxy_http_version 1.1;
            proxy_set_header   Host $host;
            proxy_set_header   X-Forwarded-For $proxy_add_x_forwarded_for;
            proxy_set_header   X-Forwarded-Proto $scheme;
            proxy_set_header   X-Forwarded-Port $server_port;

            add_header Cache-Control "private, no-store" always;
            add_header Pragma "no-cache" always;
			
			add_header X-Frame-Options "DENY" always;
        }
    }
}
